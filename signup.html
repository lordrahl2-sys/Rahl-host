<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    getDoc,
    updateDoc,
    increment
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAkDLjFGnGudVZXqMmvTAxs72mwDD3hDks",
    authDomain: "rahl-host.firebaseapp.com",
    projectId: "rahl-host",
    storageBucket: "rahl-host.appspot.com",
    messagingSenderId: "98638028534",
    appId: "1:98638028534:web:1f9ad66a58bd1af52d56d7",
    measurementId: "G-5SD4095M7R"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const referrer = new URLSearchParams(window.location.search).get("ref");

  document.getElementById("signup-btn").onclick = async () => {
    const fullName = document.getElementById("fullName").value.trim();
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;

    if (!fullName || !email || !password) {
      return alert("Please fill all fields.");
    }

    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;

      await setDoc(doc(db, "users", user.uid), {
        fullName,
        email,
        coins: 10,
        referredBy: referrer || null
      });

      // Reward referrer if exists
      if (referrer) {
        const refSnap = await getDoc(doc(db, "referralIndex", referrer));
        if (refSnap.exists()) {
          const refUid = refSnap.data().uid;
          await updateDoc(doc(db, "users", refUid), {
            coins: increment(20)
          });
        }
      }

      // Store referral link for new user
      await setDoc(doc(db, "referralIndex", fullName.toLowerCase().replace(/\\s+/g, '')), {
        uid: user.uid
      });

      alert("Signup successful!");
      window.location.href = "dashboard.html";
    } catch (err) {
      console.error(err);
      alert(err.message);
    }
  };
</script>
